\subsection{Nodo Sensor}
El nodo sensor en el contexto de nuestro proyecto se compone de tres etapas esenciales:

\begin{itemize}
\item Etapa de Adquisición de Datos
\item Etapa de Procesamiento
\item Etapa de Comunicación
\end{itemize}

La arquitectura del nodo sensor se ilustra en la figura siguiente:

\insertimage[\label{architecture_nodo_sensor}]{secciones/section_4/images/sensor_simple}{width=16cm}{Arquitectura del Nodo Sensor}

Dado que la función principal del nodo sensor es la detección de la presencia de un vehículo, es imperativo abordar la integración de componentes que cumplirán este propósito. Esto incluye la incorporación de sensores capaces de detectar la presencia de vehículos, un microcontrolador para procesar y transmitir los datos, así como la elección de la tecnología de comunicación. Continuando con nuestra discusión, nos enfocaremos en el primer componente esencial: los sensores. Analizaremos sus opciones y determinaremos cuáles son los candidatos más adecuados para nuestra solución.

\subsubsection{Tipo de sensores disponibles}
Los sistemas de estacionamiento inteligente ocupan un lugar importante como una de las
infraestructuras esenciales que permite llevar a cabo el IoT en las Smart Cities. Como mencionamos anteriormente es fundamental poder detectar un vehículo con una buena presición sin arrojar falsos positivos y manteniendo un nivel de consumo de energía bajo para maximizar el tiempo de vida de la batería. 

Del análisis de nuestra investigación en cuanto a los sensores disponibles y teniendo en cuenta también cuales son utilizados en productos comerciales de características similares vamos a enforcarnos en este informe en los siguientes sensores:
\begin{itemize}
    \item Sensor ultrasónico
    \item Sensor ToF
    \item Magnetómetro
    \end{itemize}
\subsubsubsection{Sensor Ultrasónico}
Un sensor ultrasónico es un dispositivo electrónico que mide la distancia de un objeto
objetivo emitiendo ondas de sonido ultrasónico y convierte el sonido reflejado en una
señal eléctrica. Las ondas ultrasónicas viajan más rápido que la velocidad del sonido
audible (es decir, el sonido que los humanos pueden escuchar). Los sensores ultrasónicos
tienen dos componentes principales: el transmisor (que emite el sonido utilizando
cristales piezoeléctricos) y el receptor (que detecta el sonido después de que ha
viajado hacia y desde el objetivo). Midiendo el tiempo transcurrido entre la generación de la onda sonora y la recepción de la onda reflejada, se puede calcular la distancia al objeto en estudio mediante la
siguiente fórmula:
\begin{equation}
    vs = 340 m/s \quad\text{(Velocidad del sonido)}\label{eqn:velocidad_del_sonido}
\end{equation}
\begin{equation}
    h_{lt} \quad\text{(Tiempo de recorrido de la señal)} \label{eqn:tiempo_recorrido_señal}
\end{equation}
\begin{equation}
    \frac{h_{lt} . vs}{2} = d \quad\text{(Formula de distancia al objetivo)} \label{eqn:distancia_de_la_onda}
\end{equation}

En nuestro contexto, dado que estamos trabajando en un prototipo y considerando las diversas opciones disponibles en el mercado, hemos elegido analizar el sensor ultrasónico HC-SR04. Este sensor es ampliamente utilizado en el ámbito del prototipado por ser sencillo de implementar, de facil acceso y coste y ofrece una resolución que se ajusta a los requisitos de nuestro proyecto. A continuación, se adjunta una imagen del sensor real:

\insertimage[\label{sensor_ultrasonico}]{secciones/section_3/images/sensor_ultrasonico}{width=11cm}{Sensor ultrasónico HC-SR04}

\subsubsubsection{Sensor de tiempo de vuelo (Time-of-Flight)}
Los sensores de este tipo se basan en el mismo principio de funcionamiento que los sensores ultrasónicos, con la diferencia de que en este caso la onda transmitida es una onda electromagnética. Debido a que emplean una fuente de luz con un haz muy estrecho, son especialmente adecuados para determinar la distancia a la superficie que se encuentra directamente enfrente de ellos.

Dentro de la gama de sensores de acceso comercial, se destaca el modelo VL53L0X, el cual comparte características similares con el sensor ultrasónico analizado previamente. Este sensor también es de fácil implementación y acceso, y ofrece lecturas mucho más precisas en comparación con el caso anterior. Además de esto, dado que es físicamente más pequeño, al momento de la implementación, la oclusa que debe dejarse en la carcasa es considerablemente menor en comparación con el espacio requerido por el sensor ultrasónico. Esto contribuye a reducir el potencial número de falsos positivos que puedan ocurrir. A continuación, se adjunta una imagen del sensor real:

\insertimage[\label{sensor_radar}]{secciones/section_3/images/sensor_radar}{width=6cm}{Sensor tiempo de vuelo VL53L0X}

\enabletablerowcolor[2] % Activa el color de celda
\begin{table}[H]
    \centering
    \caption{Tabla de especificaciones del sensor laser VL53L0X}
    \begin{tabular}{|p{6cm}|*{2}{>{\raggedright\arraybackslash}p{5cm}|}}
        \hline
        \textbf{Parámetro} & \textbf{VL53L0X} \\
        \hline
            Ranging chip &VL53L0X \\
            Measuring distance & 2M (Max) \\
            Measuring Mode & Default, High precision, Long Distance, High Speed \\
            Infrared emission mechanish &940nm \\
            FOV & 25º \\
            Operating Voltage & 3 - 5V \\
            Operating temperature & -20°C - 80°C \\
        \hline
        \end{tabular}
    \label{tab:tabla_parametros_sensor_laser}
\end{table}


\subsubsubsection{Magnetómegro}
Los magnetómetros son dispositivos utilizados para medir y detectar campos magnéticos en
el entorno. Estos campos magnéticos pueden ser generados por imanes, corrientes
eléctricas o incluso por la presencia de materiales magnéticos. Los magnetómetros juegan
un papel importante en una amplia gama de aplicaciones, desde navegación y geofísica
hasta ciencia espacial y medicina.

Los magnetómetros permiten medir la intensidad y la dirección del campo magnético en una
ubicación específica. Esto proporciona información crucial para entender y analizar
fenómenos magnéticos en diferentes contextos. Algunos magnetómetros también son capaces
de medir campos magnéticos en varias dimensiones, lo que proporciona una visión completa
de la distribución y orientación del campo magnético.

\insertimage[\label{magnetometro}]{secciones/section_3/images/magnetometro}{width=6cm}{Magnetómetro HMC5883L}

Existen diferentes tipos de magnetómetros, cada uno con sus propias características y
principios de funcionamiento. Algunos de los tipos más comunes incluyen magnetómetros de
efecto Hall, magnetómetros de flujo de inducción, magnetómetros de SQUID
(Superconducting Quantum Interference Device) y magnetómetros de protones.

En resumen, podemos utilizar estos dispositivos para medir cómo un vehículo distorsiona
el campo magnético terrestre y así determinar si una plaza de estacionamiento está
ocupada o no. En nuestro caso optamos por analizar el sensor comercial HMC5883L cuya imagen se muestra en la figura \ref{magnetometro}.

\enabletablerowcolor[2] % Activa el color de celda
\begin{table}[h!]
    \centering
    \caption{Tabla de especificaciones del sensor magnético HMC5883L}
    \begin{tabular}{|p{6cm}|*{2}{>{\raggedright\arraybackslash}p{5cm}|}}
        \hline
        \textbf{Parámetro} & \textbf{HMC5883L} \\
        \hline
            Voltage Supply (Vs) &2V16 - 3V6 \\
            Digital Supply (VDDIO) (max) & 1.71V - 3V7 \\
            Abs. Max VDD/VDD IO & -0.3V - 4.8V \\
            Interface &I2C \\
            I2C Address (R,W) [RW] &0x3D, 0x3C \\
            I2C rates (kHz) & 100, 400, 3400 \\
            Resolution (ADC) & 12  bits \\
            Max Gauss (survival) & Not specified. \\
            Gauss Resolution & ±2mG - ±8G \\
            Acquisition time &6ms \\
            Active current (7Hz,10Hz) &100uA \\
            Active current &Not specified. \\
            Peak Active current &Not Specified[3] \\
            Standby mode (leakage) & 2uA \\
            Operating temperature & -30°C - 85°C \\
        \hline
        \end{tabular}
    \label{tab:tabla_parametros_sensor_magnetico}
\end{table}



\subsubsection{Elección del sensor/es}
En la sección anterior, se presentaron las características de tres sensores diferentes que podrían ser útiles para detectar la ocupación de un vehículo. Sin embargo, no se proporcionó un análisis detallado de las pruebas realizadas ni se especificó cuáles de estos sensores se seleccionarían para su implementación en este proyecto.

En relación con el objetivo principal que debe cumplir el nodo sensor: detectar un vehiculo, se consideró inicialmente el uso de sensores ultrasónicos. Estos sensores son económicos, ampliamente disponibles y capaces de detectar vehículos de manera eficiente. Sin embargo, presentan desventajas significativas, como su tamaño y su principio de funcionamiento. En particular, si el sensor se encuentra parcialmente obstruido, no funcionará correctamente, lo que podría dejar el nodo sensor inoperable. Por esta razón, se descartó esta opción.

Continuando con nuestro análisis, se llevaron a cabo pruebas con el sensor ToF VL53L0X, que comparte el mismo principio de funcionamiento que los sensores ultrasónicos. Este sensor ofrece características notables, como la capacidad de no proporcionar muestras cuando el objeto está fuera de su rango de lectura, una mayor velocidad de respuesta y un tamaño físico más reducido. Para ilustrar este punto, se presentan las figuras \ref{VL53L0X_PLOTS}, que muestran los resultados de un experimento realizado al estacionar un vehículo tanto en posición frontal como trasera sobre este dispositivo.

Las figuras indican claramente que el sensor ToF no proporciona muestras cuando no hay un vehículo posicionado sobre él, lo que confirma que solo se obtienen datos cuando un objeto está presente. Además, se observa una variación evidente en las gráficas que representan la distancia en milímetros entre el sensor y el chasis del vehículo en función del tiempo.

\begin{images}[\label{VL53L0X_PLOTS}]{Mediciones realizadas con el sensor VL53L0X}
    \addimage[\label{VL53L0X_PLOTS_1}]{secciones/section_4/images/vl53l0x_forward}{width=8cm}{}
    \addimage[\label{VL53L0X_PLOTS_2}]{secciones/section_4/images/vl53l0x_back}{width=8cm}{}
\end{images}

A pesar de las ventajas del sensor ToF, surge un problema relacionado con su alto consumo de energía, lo que agotaría rápidamente la batería si se utilizara para medir continuamente la ocupación del estacionamiento. Por lo tanto, no es una opción viable para una monitorización continua.

En este punto, resta considerar el magnetómetro, que supera el problema del alto consumo de energía. Sin embargo, al observar las gráficas que representan la variación del campo magnético sobre el eje Z (altura) del magnetómetro, obtenidas al repetir el mismo experimento mencionado anteriormente, se observa que estas gráficas son mucho más ruidosas. A pesar de ello, muestran una variación clara cuando un vehículo pasa sobre el sensor.

\begin{images}[\label{QMC5883L_PLOT}]{Mediciones realizadas con el sensor QMC5883L}
    \addimage[\label{QMC5883L_PLOT_1}]{secciones/section_4/images/qmc5883l_forward}{width=8cm}{}
    \addimage[\label{QMC5883L_PLOT_2}]{secciones/section_4/images/qmc5883l_back}{width=8cm}{}
\end{images}

En vista de las consideraciones anteriores, surge la pregunta de si es posible combinar el sensor ToF con un enfoque de bajo consumo de energía. Esto podría ser una opción viable si el sistema se implementa en un estacionamiento público o en la calle, donde simplemente se necesita proporcionar información a los usuarios sobre la disponibilidad de espacios de estacionamiento, sin la opción de reservas. Sin embargo, en nuestro caso, es fundamental poder reflejar la ocupación en tiempo real (o lo más cercano posible) para gestionar las reservas de manera efectiva. Por lo tanto, considerando lo mencionado anteriormente sobre los sensores, hemos decidido utilizar una combinación de dos sensores para detectar la presencia de un vehículo, aprovechando las ventajas del magnetómetro y el sensor ToF.

El magnetómetro realizará lecturas de manera continua para detectar cambios en las proximidades del sistema debido a su bajo consumo de energía. Como el magnetómetro tiene una precisión limitada, habilitará al sensor ToF cuando detecte cambios, lo que permitirá al sistema confirmar si estos cambios se deben a la entrada o salida de un automóvil en el espacio de estacionamiento. 

Por todo lo mencionado anteriormente y sumado a un análisis comparativo que se presenta en la tabla a continuación optamos por la combinación de ambos sensores para su implementación en este proyecto.

\clearpage
\enabletablerowcolor[2] % Activa el color de celda
\begin{table}[ht]
    \centering
    \caption{Tabla comparativa entre sensores}
    \begin{tabular}{|p{8cm}|*{2}{>{\raggedright\arraybackslash}p{3cm}|}}
        \hline
        \textbf{} & \textbf{ToF} & \textbf{Magnetómetro} \\
        \hline
        Fiabilidad frente al movimiento de vehículos cercanos & SI & NO \\
        Fiabilidad frente a vehículos estacionados en las proximidades & SI & NO \\
        Fiabilidad frente a interferencias electromagnéticas & SI &NO \\
        Fiabilidad en cualquier escenario de iluminación &SI &SI \\
        Estabilidad durante estancias prolongadas del vehículo &SI &NO \\
        No necesita apertura en la caja &SI &SI \\
        Inmunidad contra la suciedad o el polvo en la caja &SI &SI \\
        Optimización en consumo de energía &NO &SI \\
        \hline
        \end{tabular}
    \label{tab:tabla_comparativa_sensore}
\end{table}
\disabletablerowcolor % Desactiva el color de celda

% SUB-SECCIÓN
\subsubsection{Elección tecnología de comunicación - ¿Por qué LoRa?}
Como se mencionó en la introducción de nuestro nodo sensor, uno de los requisitos clave de este dispositivo es su capacidad para transmitir información sobre la ocupación de un espacio de estacionamiento. La elección de la tecnología de comunicación adecuada es crucial para lograr este objetivo. En nuestro análisis, consideramos varios factores:

\begin{itemize}
    \item Costo del nodo
    \item Costo de infraestructura de la red
    \item Consumo energético
    \item Ancho de banda
    \item Cobertura
    \item Disponibilidad de acceso a la tecnología
    \item Latencia
    \item Etc.
\end{itemize}

Dado la naturaleza del proyecto, la tasa de transferencia de datos y la latencia de la comunicación son factores menos relevantes, ya que solo necesitamos enviar una cantidad limitada de información al servidor. En cambio, nos preocupamos principalmente por maximizar la vida útil de la batería, reducir los costos del nodo y la infraestructura de la red, aumentar el rango de transmisión y la cobertura, y garantizar la disponibilidad de acceso a la tecnología en Argentina.

Con estos criterios en mente, llegamos a la conclusión de que las tecnologías inalámbricas de bajo consumo, conocidas como LPWAN (Low Power Wide Area Network o Red de Bajo Consumo y Área Extensa), eran las más adecuadas para nuestro proyecto. Dentro de estas tecnologías, destacamos Sigfox y LoRa.

Las redes LPWAN se caracterizan por su bajo consumo de energía, su baja potencia de transmisión y su capacidad limitada de datos. Esto permite que los dispositivos finales sean alimentados por baterías con una vida útil prolongada. Aunque existen varias tecnologías inalámbricas, como Wi-Fi y Bluetooth, que son más conocidas en la sociedad, estas no son adecuadas para soluciones IoT debido a su alto consumo de energía y su limitada cobertura.

Siguiendo con lo mencionado anteriormente, Wi-Fi y Bluetooth se descartaron por su alto consumo de energía y su limitada cobertura. Además, la inmunidad al ruido en el canal de Bluetooth es baja, lo que podría afectar la comunicación del sensor con el servidor. Además, en entornos de estacionamiento con múltiples pisos o extensiones considerables, sería necesario implementar múltiples gateways o repetidores para utilizar estas tecnologías, lo que resultaría poco práctico e incrementaría además el costo de la red.

En cuanto a Zigbee, su principal desventaja radica en su dependencia del factor humano, ya que la configuración y el mantenimiento de la red pueden ser complicados. Esto dificultaría la creación de un dispositivo final de fácil instalación. Además, el costo de Zigbee es más elevado que el de las tecnologías mencionadas anteriormente.

Finalmente, nos centraremos en dos tecnologías ampliamente utilizadas en el ámbito del IoT: Sigfox y LoRa. Ambas comparten características como un amplio alcance, bajo consumo de energía y la capacidad de transmitir datos a larga distancia. Sin embargo, Sigfox presenta ciertas limitaciones, como la cantidad máxima de mensajes que se pueden enviar por día y la dependencia de la cobertura proporcionada por el proveedor de servicios.

Por otro lado, LoRa ofrece un amplio alcance tanto en áreas urbanas como rurales, sin limitaciones en la cantidad de mensajes que pueden enviarse y utilizando un espectro gratuito. Además, en caso que el proyecto escale puede implementarse un gateway industrial a través de LoRaWAN, un protocolo basado en LoRa, que permitiría gestionar múltiples estacionamientos o redes de gran tamaño.

Dada esta evaluación y después de considerar todas las opciones disponibles, pensamos que LoRa es la tecnología más prometedora para ser utilizada en este proyecto. Además, para brindar una visión más completa de nuestra decisión, presentamos una tabla comparativa de las características de las tecnologías de comunicación consideradas:

% Tablas
\enabletablerowcolor[2] % Activa el color de celda
\begin{table}[H]
    \centering
    \caption{Tabla comparativa sobre tecnologías de comunicación}
    \begin{tabular}{|l|*{5}{>{\raggedright\arraybackslash}p{1.8cm}|}}
        \hline
        \textbf{} & \textbf{BLE} & \textbf{WiFi} & \textbf{ZigBee} & \textbf{Sigfox} & \textbf{LoRa} \\
        \hline
        Frecuency               & Unlicensed ISM    & Unlicensed ISM bands & Unlicensed ISM & Unlicensed ISM bands & Unlicensed ISM bands \\
        Bandwidth               & 2,4 GHz           & 2,4-5GHz             & 868MHz (Europe) and 2.4 GHz (World) & 100 Hz & 250kHz and 125 kHz \\
        Maximum data rate       & 1Mbps             & 150-200 Mbps up to  600Mbps & 250 kbps & 100 bps &50 kbps \\
        Bidirectional           & Yes               & Yes & Yes & Limited & Yes \\
        Maximum messages/day    & Unlimited         & Unlimited & Unlimited & 140 (UL), 4(DL) &Unlimited \\
        Range                   & 10m ~ 1 km        & 15m ~ 100m & 10 ~100m & 10 km (urban), 40 km (rural) & 5 km (urban), 20 km (rural) \\
        Interference immunity   & Low               & Low & High & Very high & Very high \\
        Allow private network   & Yes               & Yes & Yes & No &Yes \\
        Spectrum cost           & Free              & Free & Free & Free & Free \\
        Supported Topology      & P2P, Start, Mesh  & Start, Mesh & Mesh & Start & Start \\
        Energy consumption      & Mid               & High & Mid & Low & Low \\
        \hline
        \end{tabular}
    \label{tab:tabla_comparativa_tecnologia}
\end{table}
\disabletablerowcolor % Desactiva el color de celda

% ================================================================================
\subsubsection{Microcontrolador}
En el proceso de selección de un microcontrolador para implementar nuestro prototipo, considerando que hemos optado previamente por la tecnología LoRa como nuestro medio de comunicación, evaluamos la posibilidad de emplear un microcontrolador ampliamente utilizado en el ámbito del Internet de las Cosas (IoT), como es el caso del ESP32. Esta elección se basa en una de sus ventajas más destacadas: su bajo consumo de energía. Esta característica es fundamental para dispositivos alimentados por batería, ya que permite una mayor duración de la misma.

Además de su eficiencia energética, el ESP32 ofrece una gama completa de periféricos, incluyendo I2C, SPI, UART y SDIO, que facilitan la comunicación con otros dispositivos y sensores. También integra conectividad Wi-Fi y Bluetooth, lo cual resulta valioso si se desea implementar una red local durante la inicialización del nodo sensor. Esta red podría utilizarse para configurar parámetros esenciales del nodo de manera sencilla y amigable para el usuario, como el ID del estacionamiento o el ID del concentrador al que deben enviar datos.

Es relevante mencionar que, aunque la creación de una zona Wi-Fi y una configuración detallada de parámetros mediante un servidor web no se encuentra dentro del alcance de este proyecto, se proporciona una breve introducción sobre cómo la actualización por aire a través de Wi-Fi (OTA) podría ser beneficiosa en el Anexo ~\ref{configuracion_wifi}. Además, se plantea como una posible mejora futura en la sección ~\ref{potencial_mejora_wifiOTA}.

Retomando el enfoque en el microcontrolador elegido, en nuestra búsqueda encontramos que el fabricante HELTEC ofrecía una placa de desarrollo denominada \quotes{WiFi LoRa 32 V2} que resultaba sumamente atractiva en términos de relación costo-beneficio. Esta placa integra el chip ESP32 y el módulo LoRa SX1278, lo que eliminaba la necesidad de adquirir una placa LoRa por separado para comunicarse mediante SPI con el ESP32. Además, la placa de desarrollo cuenta con una pantalla, que aunque no se utilizó en este proyecto, podría ser útil para aplicaciones futuras, como depuración o pruebas de conectividad entre dispositivos. A continuación puede verse la placa de desarrollo Heltec: 

\insertimage[\label{heltec_lora}]{secciones/section_4/images/heltec}{width=13cm}{Placa de desarrollo Heltec Lora WiFi v2}

Para proporcionar más detalles sobre el equipo Heltec WiFi LoRa 32, es importante destacar que esta placa se orienta hacia el IoT. Se basa en el microcontrolador ESP32 y utiliza el chip SX1278 integrado para las comunicaciones LoRa. Estos dos dispositivos interactúan a través de una interfaz de comunicación Serial Peripheral Interface (SPI). Es importante señalar que el chip SX1278 es el apropiado para su uso en Argentina debido a las bandas de frecuencia permitidas.

Dicho esto, vamos a utilizar la placa de la figura \ref{heltec_lora} en nuestro nodo sensor. Además dejamos una tabla de de especificaciones tecnicas para mayor referencia a continuación.


\enabletablerowcolor[2] % Activa el color de celda
\begin{table}[ht]
    \centering
    \caption{Tabla de parámetros Heltect WiFi LoRa 32 v2}
    \begin{tabular}{|p{2cm}|*{3}{>{\raggedright\arraybackslash}p{14cm}|}}
        \hline
        \textbf{Parámetro} & \textbf{Descripción} \\
        \hline
        Master Chip & ESP32 (240MHz Tensilica LX6 dual-core+1 ULP, 600 DMIPS) \\
        LoRa Chipset & SX1278 \\
        Wi-Fi & 802.11 b/g/n (802.11n up to 150 Mbps) \\
        Bluetooth &Bluetooth V4.2 BR/EDR and Bluetooth LE specification \\
        Hardware Resource & UART x 3; SPI x 2; I2C x 2; I2S x 1; 12-bits ADC input x 18; 8\-bits DAC output x 2; GPIO x 22; GPI x 6 \\
        Memory &8MB(64M-bits) SPI FLASH; 520 KB internal SRAM \\
        Interface &Micro USB x 1; LoRa Antenna interface(IPEX) x 1 \\
        Dimensions &51 x 25.5 x 10.6 mm \\
        \hline
        \end{tabular}
    \label{tab:tabla_parametros_heltec}
\end{table}
\disabletablerowcolor % Desactiva el color de celda

\subsubsubsection{PinOut}
\insertimage[\label{heltec_pinout}]{secciones/section_4/images/pinout_heltec}{width=14cm}{Pinout placa de desarrollo Heltec Lora WiFi v2}

\newpage
\subsubsection{Plano esquemático}
\insertimage[\label{plano_esquematico}]{secciones/section_4/images/Schematic_smartparking-sensor}{width=12.5cm}{Plano esquematico del nodo sensor}



\subsubsection{Firmware}
El firmware fue dividido en dos subsistemas con la finalidad de optimizar la eficiencia de la batería. El primer subsistema, denominado \quotes{subsistema de bajo consumo}, se encarga de realizar un monitoreo continuo con el propósito de detectar anomalías y, en caso de detección, activar el subsistema siguiente. Por su parte, el segundo subsistema, denominado \quotes{subsistema de alto consumo}, verifica si las anomalías detectadas corresponden a un cambio en el estado de ocupación de la plaza. Posteriormente, este subsistema transmite los resultados a través del canal LoRa hacia el concentrador.

\insertimage[\label{power_modes_system}]{secciones/section_4/images/power_modes_system}{width=17cm}{Subsistemas}


\subsubsubsection{Detección de anomalías (DA)}\label{detector_anomalias}
La detección de anomalías, a veces denominada identificación de valores atípicos u outliers en inglés, se refiere a la tarea de identificar elementos, eventos u observaciones que son poco comunes y se desvían significativamente de la mayoría de los datos, no conformando así un patrón claramente definido de comportamiento normal.

En el contexto del nodo sensor, nuestro objetivo principal radica en la identificación de anomalías en los valores del campo magnético que son registrados por el magnetómetro. Estas anomalías pueden estar vinculadas al desplazamiento de objetos que se encuentran en proximidad al sensor. Es relevante destacar que, aunque reconocemos que el campo magnético terrestre experimenta fluctuaciones, es razonable tratarlo como una constante en cortos intervalos de tiempo, en nuestro caso, en el orden de segundos.

Para establecer una referencia en cuanto a lo que se considera un valor típico en estas magnitudes, empleamos una técnica conocida como \quotes{media móvil}. Este algoritmo considera como valor normal el resultado obtenido al calcular el promedio de las últimas $n$ mediciones. La detección de anomalías se lleva a cabo al comparar la última medición registrada con el valor más reciente calculado por la media móvil. Cuando la diferencia supera un umbral previamente definido, se identifica como una anomalía.

En la Figura \ref{comparativa_anomalias_forw} ilustramos el proceso en cuestión. En la primera gráfica, de arriba a abajo, se muestran los datos del campo magnético capturados por el magnetómetro cuando un vehículo se aproxima de manera frontal al sensor. La segunda gráfica muestra los resultados obtenidos al aplicar una media móvil de veinte periodos a los datos previamente mencionados. Finalmente, la tercera gráfica presenta la magnitud en valor absoluto de la diferencia entre el valor del campo magnético en el instante $n$ de la primer gráfica y la media móvil en el instante $n-1$ de la segunda.
Si nos desplazamos de derecha a izquierda, observamos que inicialmente, en ausencia de cualquier objeto que pueda influir en el campo magnético, los valores permanecen constantes en torno a los 520 miliGauss (mG), lo que conlleva a una variación prácticamente insignificante. Sin embargo, al acercarnos a la muestra doscientos, comenzamos a presenciar una variación en el campo magnético debido a la aproximación del vehículo, lo que resulta en un notable aumento en la variabilidad. Posteriormente, cuando el automóvil se detiene, el campo magnético se estabiliza y la variación vuelve a ser nula. Este patrón persiste hasta que el automóvil inicia su retroceso, aproximadamente en la muestra quinientos, lo que provoca una alteración en el campo significativa como para generar un incremento sustancial en la variación.

\insertimage[\label{comparativa_anomalias_forw}]{secciones/section_4/images/qmc5883l_forward_analysis}{width=16cm}{Estacionamiento frontal}

Sobre el lado derecho de la figura \ref{esquema_energia} se detalla como opera el detector en el subsistema de bajo consumo, el paso \quotes{Compute delta} es el encargado de actualizar la media móvil y calcular la diferencia. Posteriormente, si esta última excede un umbral predefinido, procede a activar el subsistema de alto consumo.


\subsubsubsection{Confirmación de ocupación}
Este paso consiste en utilizar un segundo sensor, en nuestro caso el sensor ToF VL53L0X, para confirmar que los eventos detectados por el DA se corresponden a cambios en el estado de ocupación del espacio de estacionamiento. El sensor opera entregando la distancia en milímetros, si se detecta un objeto en el rango de medición, o \quotes{error} en caso contrario. De esta manera, hemos definido un rango de quinientos milímetros (aproximadamente la altura promedio de los automóviles es de 220 milímetros), en el cual cualquier objeto detectado a esta distancia o menos se considera un vehículo, lo que resulta en que la plaza de estacionamiento se considere ocupada. En caso contrario, es decir, si el sensor no detecta ningún objeto o si el objeto se encuentra fuera del rango predefinido, se infiere que la plaza de estacionamiento se encuentra libre.
En el caso de que la ocupación haya cambiado, ya sea porque estaba libre y paso a ser considerada ocupada o viceversa, la información pasa al siguiente módulo, para ser reportada al concentrador.
En el sector izquierdo de la figura \ref{esquema_energia}, dentro del subsistema de algo consumo, puede verse el funcionamiento de este módulo.

\subsubsubsection{Transmisión de la información}
Al detectase una variación en el estado de ocupacion del lugar de estacionamiento el sensor transmitir este evento al concentrador por medio de LoRa y para ello lo primero es seleccionar los datos a ser enviados, en nuetro caso el identificador del sensor (\quotes{id}) y si esta libre o ocupado (\quotes{taken}).

\begin{lstlisting}[style=json]
    {
        "id": number,
        "taken": bool
    }
\end{lstlisting}

Luego los datos para poder ser modulados deben ser serializados, para esto empleamos el estándar denominado CBOR. Este protocolo nos posibilita la transmisión de información en un formato de clave-valor. A diferencia del formato JSON, CBOR almacena los datos en una representación binaria más compacta. Esta característica tiene un impacto significativo en la cantidad de datos que deben ser transmitidos, lo cual es de suma importancia en entornos que hacen uso de la tecnología LoRa. Además de su eficiencia en la reducción del uso de ancho de banda, CBOR destaca por su capacidad de procesamiento más veloz lo que conlleva a una disminución del tiempo durante el cual el microcontrolador permanece en un estado de alto consumo de energía y por lo tanto se incrementa el tiempo de vida de la batería.
Dado que los datos se encuentran representados en forma de una matriz binaria, podemos proceder con el proceso de transmisión. Este procedimiento implica la copia de la matriz en la memoria del módulo SX1278, la modificación del modo de operación del mismo para habilitar la transmisión, la configuración de la Unidad de Procesamiento de Interrupciones (UPI) de la ESP de manera que pueda gestionar la interrupción generada por el SX1278 una vez que concluye la transmisión, y finalmente, la activación del modo de reposo ligero (light sleep) de la ESP. Una vez que este conjunto de operaciones se completa, se procede a configurar el transceptor en modo de recepción durante un intervalo de tiempo predeterminado. Es en este intervalo en el cual se aguarda la recepción de un \quotes{acuse de recibo} por parte del concentrador, confirmando así la correcta recepción del mensaje transmitido.
En caso de que este proceso no se complete adecuadamente debido a la falta de confirmación de la recepción del mensaje, se activa un mecanismo de retransmisión. En este proceso, primero se espera un período de tiempo aleatorio y luego se verifica la disponibilidad del canal antes de proceder con la retransmisión.
Una vez enviado el mensaje el microcontrolador regresa al modo de Deep-Sleep, preparado para realizar nuevas detecciones de vehículos.


\insertimage[\label{esquema_energia}]{secciones/section_4/images/esquema_energia}{width=17cm}{Diagrama de flujo del nodo sensor}


\subsubsection{Estimación tiempo de vida util - bateria del nodo sensor}{\label{sec:bateria_del_nodo_sensor}}
Dada la naturaleza de nuestro proyecto, uno de los aspectos clave del mismo en la
implementación del nodo sensor es el diseño de este para que consuma muy poca energía y
además acompañar esta implementación junto con la estimación en el tiempo de vida útil
del nodo.
Al lograr estimar la vida útil de la batería, se pueden tomar mejores decisiones para
realizar una planificación del mantenimiento y la sustitución anticipada de la batería,
lo que contribuye a evitar interrupciones en el funcionamiento del sistema.

A continuación introduciremos los conceptos claves junto con los cálculos necesarios
para lograr la implementación y la estimación del tiempo de vida.

\subsubsubsection{ESP32 - Low-Power Management}
Conforme se destacó en la introducción de esta sección, resulta crucial considerar el
consumo de energía durante el desarrollo del nodo sensor. Nuestra investigación revela
que el microcontrolador a emplear ofrece cuatro (4) perfiles de energía distintos, como
se muestra en la imagen adjunta.

\insertimage[\label{esp_low_power}]{secciones/section_4/images/esp_low_power}{width=17cm}{Modos de consumo de energía ESP32}

Durante el modo de suspensión profunda (deep sleep), la CPU principal se apaga, mientras
que el Coprocesador Ultra-Bajo Consumo (ULP) puede tomar lecturas de sensores y
despertar a la CPU según sea necesario. Este tipo de perfil de energía es útil para
diseñar aplicaciones en las que la CPU debe despertarse por un evento externo, un
temporizador o una combinación de estos eventos, manteniendo un consumo mínimo de
energía.

Debido a que la memoria RTC se mantiene activa, su contenido se conserva incluso durante
el modo de suspensión profunda y se puede recuperar una vez que el chip se despierta.
Para una mejor ejemplificación adjuntamos el diagrama de bloques con aquellos bloques
que siguen activos durante el modo de funcionamiento Deep-Sleep.

\insertimage[\label{diagrama_low_power_bloques}]{secciones/section_4/images/diagrama_low_power_bloques}{width=15cm}{Bloques activos en modo Deep-Sleep}

\subsubsubsection{Cálculo teórico - tiempo de vida batería}
Antes de adentrarnos en esta sección, es importante aclarar que, dado que estamos trabajando con una placa de desarrollo, el consumo de energía real puede ser mayor que el indicado en las hojas de datos de los fabricantes. Además, la placa está siendo alimentada de manera continua, lo que significa que cualquier estimación de consumo de energía en una futura aplicación carecería de fundamentos sólidos. Para futuros desarrollos, planeamos utilizar el chipset ESP32 junto con los sensores mencionados previamente. En ese caso, podremos basarnos en los valores proporcionados en las hojas de datos de los fabricantes para realizar cálculos más precisos sobre la vida útil de la batería.

Ahora, para estimar con precisión el tiempo de vida de la batería necesario para nuestro equipo, hemos llevado a cabo una identificación meticulosa de dos patrones de consumo claramente definidos: \textit{Alto Consumo} y \textit{Bajo Consumo}. Cada uno de estos patrones tiene sus propios períodos de funcionamiento \quotes{ON} y de inactividad \quotes{OFF}. Este análisis detallado nos permitirá obtener una estimación más precisa y detallada del tiempo de vida esperado de la batería. De esta manera, podremos tomar decisiones informadas acerca de la capacidad y durabilidad óptimas para el sistema electrónico en cuestión. Es importante destacar que este enfoque se basa en la observación de que muchos sistemas IoT pasan la mayor parte de su tiempo en modo de bajo consumo, alternando con breves períodos de funcionamiento activo.

Comenzaremos realizando los cálculos para el sistema de \textbf{bajo consumo}, que presenta los siguientes parámetros:

\begin{flalign}
    I_{\text{ULP on}} &= 400 \, \mu\text{A} &&\text{Corriente ULP encendido}
\end{flalign}
\begin{flalign}
    t_{\text{ULP on}} &= 2 \, ms &&\text{Tiempo ULP encendido}
\end{flalign}
\begin{flalign}
    I_{\text{ULP off}} &= 10 \, \mu\text{A} &&\text{Corriente ULP apagado}
\end{flalign}
\begin{flalign}
    t_{\text{ULP off}} &= 500 \, ms &&\text{Tiempo ULP apagado}
\end{flalign}
\begin{flalign}
    I_{\text{ULP}} &= \frac{I_{\text{ULP on}} \, t_{\text{ULP on}} + I_{\text{ULP off}} \, t_{\text{ULP off}}}{t_{\text{ULP on}} + t_{\text{ULP off}}} = 11,55 \, \mu\text{A} &&\text{Corriente ULP}
\end{flalign}
\begin{flalign}
    I_{\text{MAG}} &= 20 \, \mu\text{A} &&\text{Corriente magnetómetro}
\end{flalign}
\begin{flalign}
    I_{\text{LP}} &= I_{\text{ULP}} + I_{\text{MAG}} = 0,0316 \, m\text{A} &&\text{Corriente total bajo consumo}
\end{flalign}


Por otro lado y antes de adentrarnos en los calculos para el modo de \textbf{alto consumo}, resulta fundamental abordar la estrecha relación que existe entre el consumo en cuestión y la frecuencia con la que los vehículos entran y salen de una zona de estacionamiento. Es durante estos intervalos precisos cuando el sistema se activa, y, por consiguiente, es importante destacar que a medida que la frecuencia de entrada y salida de vehículos aumenta, también se incrementa el consumo correspondiente. En el contexto de nuestros cálculos, expresaremos esta relación utilizando su inversa, es decir, el periodo.

\begin{equation}
    T_A [ms]
    \quad\text{(Tiempo entre que un auto ingresa y sale de un espacio de estacionamiento)}
\end{equation}


Corriente consumida durante la etapa de sensado ($I_{\text{S}}$):
\begin{flalign}
    I_{\text{ESP on}} &= 25 \, m\text{A} &&\text{Corriente ESP en modo activo}
\end{flalign}
\begin{flalign}
    t_{\text{ESP on}} &= 300 \, ms &&\text{Tiempo ESP en modo activo}
\end{flalign}
\begin{flalign}
    I_{\text{ESP}} &= \frac{I_{\text{ESP on}} \, t_{\text{ESP on}}}{t_{\text{ESP on}} + T_A} = \frac{7.500}{300 + T_A} \, m\text{A} &&\text{Corriente ESP total}
\end{flalign}
\begin{flalign}
    I_{\text{LASER on}} &= 19 \, m\text{A} &&\text{Corriente Laser encendido}
\end{flalign}
\begin{flalign}
    t_{\text{LASER on}} &= 40 \, ms &&\text{Tiempo Laser encendido}
\end{flalign}
\begin{flalign}
    I_{\text{LASER}} &= \frac{I_{\text{LASER on}} \, t_{\text{LASER on}}}{t_{\text{LASER on}} + T_A} = \frac{760}{40 + T_A} \, m\text{A} &&\text{Corriente Laser total}
\end{flalign}
\begin{flalign}
    I_{\text{S}} &= I_{\text{ESP}} + I_{\text{LASER}} = \frac{7.500}{300 + T_A} + \frac{760}{40 + T_A} \, m\text{A} &&\text{Corriente total sensando}
\end{flalign}


Por último, corriente consumida durante la etapa de transmisión ($I_{T}$):
\begin{flalign}
    I_{\text{SX stby}} &= 0.0015 \, \mu\text{A} &&\text{Corriente SX standby}
\end{flalign}
\begin{flalign}
    t_{\text{SX stby}} &= 27 \, ms &&\text{Tiempo SX standby}
\end{flalign}
\begin{flalign}
    I_{\text{SX tx}} &= 100 \, m\text{A} &&\text{Corriente SX transmitiendo}
\end{flalign}
\begin{flalign}
    t_{\text{SX tx}} &= 175 \, ms &&\text{Tiempo SX transmitiendo}
\end{flalign}
\begin{flalign}
    I_{\text{SX rx}} &= 12 \, m\text{A} &&\text{Corriente SX recibiendo}
\end{flalign}
\begin{flalign}
    t_{\text{SX rx}} &= 1000 \, ms &&\text{Tiempo SX recibiendo}
\end{flalign}
\begin{flalign}
    I_{\text{SX}} &= \frac{I_{\text{SX stby}} \, T_A +  I_{\text{SX stby}} \, t_{\text{SX stby}} + I_{\text{SX rx}} \,t_{\text{SX rx}} + I_{\text{SX tx}} \, t_{\text{SX tx}}}{T_A + t_{\text{SX stby}} +  t_{\text{SX rx}} + t_{\text{SX tx}}}  &&\text{Corriente SX1278} \label{corriente_total_sx1278_formula}
\end{flalign}
\begin{flalign}
    I_{\text{SX}} &= \frac{29500 + 1.5 \times 10^{-6} \, T_A}{1202 + T_A} \, m\text{A} &&\text{Corriente SX1278 total con valores reemplazados}
\end{flalign}
\begin{flalign}
    I_{\text{ESP ls}} &= 0.8 \, m\text{A} &&\text{Corriente ESP light sleep}
\end{flalign}
\begin{flalign}
    t_{\text{ESP ls}} &= t_{\text{SX tx}} + t_{\text{SX rx}} &&\text{Tiempo ESP light sleep}
\end{flalign}
\begin{flalign}
    t_{\text{ESP on}} &= t_{\text{SX stby}} &&\text{Tiempo ESP light sleep}
\end{flalign}
\begin{flalign}
    I_{\text{ESP}} &= \frac{I_{\text{ESP on}} \, t_{\text{ESP on}} + I_{\text{ESP ls}} \, t_{\text{ESP ls}}}{t_{\text{ESP on}}+ t_{\text{ESP ls}} + T_A} = \frac{1615}{1202 + T_A} \, m\text{A} &&\text{Corriente ESP total}
\end{flalign}
\begin{flalign}
    I_{\text{T}} &= I_{\text{ESP}} + I_{\text{SX}} = \frac{31115 + 1.5 \times 10^{-6} \, T_A}{1202 + T_A} \, m\text{A} &&\text{Corriente total transmitiendo}
\end{flalign}

La corriente total consumida en el modo de alto consumo:
\begin{empheq}[box=\fbox]{flalign}
    I_{\text{HP}} &= I_{\text{S}} + I_{\text{T}} = \frac{31115 + 1.5 \times 10^{-6} \, T_A}{1202 + T_A}  + \frac{7500}{300 + T_A} + \frac{760}{40 + T_A} \, m\text{A} &&
\end{empheq}

Finalmente la corriente total consumida por el sistema:
\begin{empheq}[box=\fbox]{flalign}
    I &= I_{\text{LP}} + I_{\text{HP}} = \frac{31115 + 1.5 \times 10^{-6} \, T_A}{1202 + T_A}  + \frac{7500}{300 + T_A} + \frac{760}{40 + T_A} + 0,0316 \, m\text{A} &&
\end{empheq}



En este punto ya tenemos todos los valores de intensidad expresados y podemos estimar el
tiempo de vida útil de una batería. Asumiendo que tenemos una batería de 5000 mAh, en la
gráfica a continuación se puede visualizar el tiempo de vida estimado en función de la
permanencia de vehículos en una plaza del estacionamiento.

\insertimage[\label{calculo_bateria}]{secciones/section_4/images/battery_calculation_new}{width=17cm}{Calculo teórico tiempo de vida de la batería}

En la sección de anexos, puede encontrarse el código para el cálculo y generación de la
gráfica anterior. Ver anexo ~\ref{codigo_estimacion_bateria}
